# ===============================================
# Makefile - Commandes Docker simplifiÃ©es
# ===============================================
# Usage: make <commande>
# ===============================================

.PHONY: help dev prod build up down logs restart clean test

# Couleurs pour l'affichage
YELLOW := \033[1;33m
GREEN := \033[1;32m
RED := \033[1;31m
RESET := \033[0m

# Par dÃ©faut : afficher l'aide
.DEFAULT_GOAL := help

help: ## ğŸ“‹ Afficher cette aide
	@echo "$(GREEN)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(RESET)"
	@echo "$(GREEN)  ğŸš€ MaisonLuxe - Commandes Docker                         $(RESET)"
	@echo "$(GREEN)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(RESET)"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(YELLOW)%-15s$(RESET) %s\n", $$1, $$2}'
	@echo "$(GREEN)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(RESET)"

# ===============================================
# ğŸ’» DÃ‰VELOPPEMENT
# ===============================================

dev: ## ğŸ’» DÃ©marrer en mode dÃ©veloppement (hot-reload)
	@echo "$(GREEN)ğŸš€ DÃ©marrage en mode dÃ©veloppement...$(RESET)"
	docker compose -f docker-compose.dev.yml up -d
	@echo "$(GREEN)âœ… Application disponible sur http://localhost:3000$(RESET)"

dev-build: ## ğŸ”¨ Build et dÃ©marrer en mode dev
	@echo "$(GREEN)ğŸ”¨ Build de l'image de dÃ©veloppement...$(RESET)"
	docker compose -f docker-compose.dev.yml up -d --build
	@echo "$(GREEN)âœ… Application disponible sur http://localhost:3000$(RESET)"

dev-logs: ## ğŸ“œ Voir les logs en mode dev
	docker compose -f docker-compose.dev.yml logs -f app

dev-down: ## ğŸ›‘ ArrÃªter le mode dÃ©veloppement
	@echo "$(YELLOW)ğŸ›‘ ArrÃªt du mode dÃ©veloppement...$(RESET)"
	docker compose -f docker-compose.dev.yml down

# ===============================================
# ğŸš€ PRODUCTION
# ===============================================

prod: ## ğŸš€ DÃ©marrer en mode production
	@echo "$(GREEN)ğŸš€ DÃ©marrage en mode production...$(RESET)"
	docker compose -f docker-compose.prod.yml up -d
	@echo "$(GREEN)âœ… Application en production sur http://localhost:3000$(RESET)"

prod-build: ## ğŸ”¨ Build et dÃ©marrer en mode production
	@echo "$(GREEN)ğŸ”¨ Build de l'image de production...$(RESET)"
	docker compose -f docker-compose.prod.yml up -d --build
	@echo "$(GREEN)âœ… Application en production sur http://localhost:3000$(RESET)"

prod-logs: ## ğŸ“œ Voir les logs en mode production
	docker compose -f docker-compose.prod.yml logs -f app

prod-down: ## ğŸ›‘ ArrÃªter le mode production
	@echo "$(YELLOW)ğŸ›‘ ArrÃªt du mode production...$(RESET)"
	docker compose -f docker-compose.prod.yml down

# ===============================================
# ğŸ› ï¸ COMMANDES GÃ‰NÃ‰RALES
# ===============================================

build: ## ğŸ”¨ Build l'image Docker (mode par dÃ©faut)
	@echo "$(GREEN)ğŸ”¨ Build de l'image Docker...$(RESET)"
	docker compose build

up: ## â–¶ï¸ DÃ©marrer tous les services
	@echo "$(GREEN)â–¶ï¸ DÃ©marrage des services...$(RESET)"
	docker compose up -d

down: ## â¹ï¸ ArrÃªter tous les services
	@echo "$(YELLOW)â¹ï¸ ArrÃªt des services...$(RESET)"
	docker compose down

restart: ## ğŸ”„ RedÃ©marrer tous les services
	@echo "$(YELLOW)ğŸ”„ RedÃ©marrage des services...$(RESET)"
	docker compose restart

logs: ## ğŸ“œ Afficher les logs de tous les services
	docker compose logs -f

logs-app: ## ğŸ“œ Logs de l'application uniquement
	docker compose logs -f app

logs-db: ## ğŸ“œ Logs de MongoDB uniquement
	docker compose logs -f mongodb

# ===============================================
# ğŸ§¹ NETTOYAGE
# ===============================================

clean: ## ğŸ§¹ Nettoyer les conteneurs et images
	@echo "$(YELLOW)ğŸ§¹ Nettoyage des conteneurs arrÃªtÃ©s...$(RESET)"
	docker compose down
	docker system prune -f
	@echo "$(GREEN)âœ… Nettoyage terminÃ©$(RESET)"

clean-all: ## ğŸ§¹ Nettoyer TOUT (conteneurs, images, volumes)
	@echo "$(RED)âš ï¸  ATTENTION : Suppression de tous les conteneurs, images et volumes !$(RESET)"
	@read -p "ÃŠtes-vous sÃ»r ? [y/N] " -n 1 -r; \
	echo; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		docker compose down -v; \
		docker system prune -af --volumes; \
		echo "$(GREEN)âœ… Nettoyage complet terminÃ©$(RESET)"; \
	else \
		echo "$(YELLOW)âŒ Nettoyage annulÃ©$(RESET)"; \
	fi

# ===============================================
# ğŸ” INSPECTION
# ===============================================

ps: ## ğŸ“Š Afficher l'Ã©tat des conteneurs
	@echo "$(GREEN)ğŸ“Š Ã‰tat des conteneurs :$(RESET)"
	docker compose ps

stats: ## ğŸ“ˆ Afficher les statistiques des conteneurs
	docker stats --no-stream

inspect: ## ğŸ” Inspecter tous les services
	@echo "$(GREEN)ğŸ” Inspection des services...$(RESET)"
	@echo ""
	@echo "$(YELLOW)Conteneurs :$(RESET)"
	@docker compose ps
	@echo ""
	@echo "$(YELLOW)Volumes :$(RESET)"
	@docker volume ls | grep maison-luxe
	@echo ""
	@echo "$(YELLOW)Images :$(RESET)"
	@docker images | grep maison-luxe

# ===============================================
# ğŸš ACCÃˆS SHELL
# ===============================================

shell: ## ğŸš Ouvrir un shell dans le conteneur app
	@echo "$(GREEN)ğŸš Ouverture du shell dans l'application...$(RESET)"
	docker exec -it maisonluxe-app sh

shell-db: ## ğŸ—„ï¸ Ouvrir mongosh dans MongoDB
	@echo "$(GREEN)ğŸ—„ï¸ Ouverture de mongosh...$(RESET)"
	docker exec -it maisonluxe-mongodb mongosh -u admin -p admin123

# ===============================================
# ğŸ§ª TESTS & VALIDATION
# ===============================================

test: ## ğŸ§ª Lancer les tests Docker
	@echo "$(GREEN)ğŸ§ª Validation de la configuration Docker...$(RESET)"
	bash scripts/test-docker.sh

test-build: ## ğŸ§ª Tester le build (sans dÃ©marrer)
	@echo "$(GREEN)ğŸ§ª Test du build Docker...$(RESET)"
	docker compose build --progress=plain

health: ## ğŸ¥ VÃ©rifier la santÃ© des services
	@echo "$(GREEN)ğŸ¥ VÃ©rification de la santÃ© des services...$(RESET)"
	@docker inspect --format='{{.Name}}: {{.State.Health.Status}}' $$(docker ps -q) 2>/dev/null || echo "Aucun healthcheck configurÃ©"

# ===============================================
# ğŸ’¾ BASE DE DONNÃ‰ES
# ===============================================

db-backup: ## ğŸ’¾ Backup de la base MongoDB
	@echo "$(GREEN)ğŸ’¾ CrÃ©ation du backup MongoDB...$(RESET)"
	mkdir -p backups
	docker exec maisonluxe-mongodb mongodump -u admin -p admin123 --db maisonluxe --out /tmp/backup
	docker cp maisonluxe-mongodb:/tmp/backup ./backups/backup-$$(date +%Y%m%d-%H%M%S)
	@echo "$(GREEN)âœ… Backup crÃ©Ã© dans ./backups/$(RESET)"

db-restore: ## â™»ï¸ Restaurer la base MongoDB (spÃ©cifier BACKUP_DIR=path)
	@if [ -z "$(BACKUP_DIR)" ]; then \
		echo "$(RED)âŒ Erreur : SpÃ©cifiez BACKUP_DIR=path/to/backup$(RESET)"; \
		exit 1; \
	fi
	@echo "$(YELLOW)â™»ï¸ Restauration de la base depuis $(BACKUP_DIR)...$(RESET)"
	docker cp $(BACKUP_DIR) maisonluxe-mongodb:/tmp/restore
	docker exec maisonluxe-mongodb mongorestore -u admin -p admin123 --db maisonluxe /tmp/restore/maisonluxe
	@echo "$(GREEN)âœ… Base restaurÃ©e$(RESET)"

db-reset: ## ğŸ”„ RÃ©initialiser complÃ¨tement la base
	@echo "$(RED)âš ï¸  ATTENTION : Suppression de toutes les donnÃ©es MongoDB !$(RESET)"
	@read -p "ÃŠtes-vous sÃ»r ? [y/N] " -n 1 -r; \
	echo; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		docker compose down -v; \
		docker volume rm maison-luxe_mongodb_data 2>/dev/null || true; \
		docker compose up -d; \
		echo "$(GREEN)âœ… Base rÃ©initialisÃ©e$(RESET)"; \
	else \
		echo "$(YELLOW)âŒ RÃ©initialisation annulÃ©e$(RESET)"; \
	fi

# ===============================================
# ğŸš€ DÃ‰PLOIEMENT
# ===============================================

deploy-railway: ## ğŸš‚ DÃ©ployer sur Railway
	@echo "$(GREEN)ğŸš‚ DÃ©ploiement sur Railway...$(RESET)"
	railway up

deploy-render: ## ğŸ¨ DÃ©ployer sur Render (git push)
	@echo "$(GREEN)ğŸ¨ Push vers Render...$(RESET)"
	git push origin main
	@echo "$(YELLOW)â†’ Le dÃ©ploiement se fait automatiquement sur Render$(RESET)"

# ===============================================
# ğŸ“¦ GESTION DES IMAGES
# ===============================================

pull: ## ğŸ“¦ Pull les derniÃ¨res images
	@echo "$(GREEN)ğŸ“¦ TÃ©lÃ©chargement des images...$(RESET)"
	docker compose pull

push: ## ğŸ“¤ Push l'image vers un registry (nÃ©cessite REGISTRY_URL)
	@if [ -z "$(REGISTRY_URL)" ]; then \
		echo "$(RED)âŒ Erreur : SpÃ©cifiez REGISTRY_URL=your-registry.com/image$(RESET)"; \
		exit 1; \
	fi
	docker tag maison-luxe-app $(REGISTRY_URL)
	docker push $(REGISTRY_URL)

# ===============================================
# ğŸ”§ MAINTENANCE
# ===============================================

update: ## ğŸ”„ Mettre Ã  jour et redÃ©ployer
	@echo "$(GREEN)ğŸ”„ Mise Ã  jour de l'application...$(RESET)"
	git pull origin main
	docker compose down
	docker compose up -d --build
	@echo "$(GREEN)âœ… Mise Ã  jour terminÃ©e$(RESET)"

prune: ## ğŸ§¹ Nettoyer les ressources Docker inutilisÃ©es
	@echo "$(YELLOW)ğŸ§¹ Nettoyage des ressources inutilisÃ©es...$(RESET)"
	docker system prune -f
	@echo "$(GREEN)âœ… Nettoyage terminÃ©$(RESET)"
